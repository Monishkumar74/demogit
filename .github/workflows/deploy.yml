name: Deploy to VM

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: code-artifact
        path: ./artifact

    - name: Deploy to VM
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        source: "./artifact/${{ github.ref_name }}.zip"
        target: "/tmp"

    - name: Run deployment commands on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd /tmp
          unzip ${{ github.ref_name }}.zip
          # Add your deployment commands here, e.g., cp to web directory, restart service, etc.
